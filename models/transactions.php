<?phpclass Transactions extends Dbmodel{    private $tbl_transctn="transactions";    function initiate($phone){        $time=  time();        $sql="INSERT INTO $this->tbl_transctn (`timestamp`,`ord_id`,`status`) VALUES (?,?,'initiated')";		$stmt=$this->mysqli->prepare($sql);		$stmt->bind_param('si',$time,$phone);		$stmt->execute();                if($stmt->error){                    echo $stmt->error;                }                $id=$this->mysqli->insert_id;		$stmt->close();                return $id;    }        function update_transaction($status,$stripid,$strip_customer='',$notes,$id){    	if(empty($strip_customer)){ $strip_customer=' ';}    	$time=time();        $query="UPDATE $this->tbl_transctn SET `timestamp`=$time,`status`=?,`stripid`=?,`strip_customer`=?,`notes`=? WHERE `id`=?";		$stmt=$this->mysqli->prepare($query);                $error=$this->mysqli->error;                if($error){                    return $error;                    exit();                }		$stmt->bind_param('ssssi',$status,$stripid,$strip_customer,$notes,$id);		$stmt->execute();                echo $stmt->error;        $stmt->close();            }	function manual_update($status,$notes,$ord_id){	   $time=time();	   $query="INSERT INTO $this->tbl_transctn (`timestamp`,`ord_id`,`notes`,`status`) VALUES (?,?,?,?)";       $stmt=$this->mysqli->prepare($query);                $error=$this->mysqli->error;                if($error){                    return $error;                    exit();                }		$stmt->bind_param('siss',$time,$ord_id,$notes,$status);		$stmt->execute();                echo $stmt->error;		$stmt->close();    }function charge_refund($id,$amount,$type){		if($type=="refund"){ $col="refunded"; } else {			$col="overage";		}        $query="UPDATE orders SET $col=$col+ ? WHERE `id`=?";		$stmt=$this->mysqli->prepare($query);        $error=$this->mysqli->error;                if($error){                    return $error;                    exit();                }			$stmt->bind_param('si',$amount,$id);		$stmt->execute();                echo $stmt->error;		$stmt->close();}				function get_stripe_customer($stripid){		$this->table='transactions';		$this->columns=array('strip_customer');		$this->referedby='stripid';		$this->refervalue=$stripid;		$this->select();		return $this->result['strip_customer'];	}		function overage($stripe_id,$amount){		$status="charged_overage";		$sql="SELECT ord_id FROM transactions WHERE stripid=?";		$stmt=$this->mysqli->prepare($sql);		$stmt->bind_param('s',$stripe_id);		$stmt->execute();                if($stmt->error){                    echo $stmt->error;                }		$stmt->bind_result($ord_id);		        while($stmt->fetch()){			$ord_id=$ord_id;        	}		$notes='{"Manual":"Manually '.str_replace("_"," ",$status ).' $ '.$amount.'"}';		$this->manual_update($status,$notes,$ord_id);		$this->charge_refund($ord_id,$amount,"overage");		}		function refund($stripid,$amount){		$status="refunded";		$sql="SELECT ord_id FROM transactions WHERE stripid=?";		$stmt=$this->mysqli->prepare($sql);		$stmt->bind_param('s',$stripid);		$stmt->execute();                if($stmt->error){                    echo $stmt->error;                }		$stmt->bind_result($ord_id);		        while($stmt->fetch()){			$ord_id=$ord_id;        	}		$notes='{"Manual":"Manually '.$status.' $ '.$amount.'"}';		$this->manual_update($status,$notes,$ord_id);		$this->charge_refund($ord_id,$amount,"refund");	    }         function get_order_data($transaction_id){        $result=array();		$query="SELECT `id`, `order_id`, `phone`, `amount`, `status` FROM `orders` WHERE `id`=(SELECT `ord_id` FROM `transactions` WHERE `id`=?)";		$stmt=$this->mysqli->prepare($query);                $error=$this->mysqli->error;                if($error){                    return $error;                    exit();                }		$stmt->bind_param('i',$transaction_id);		$stmt->execute();		$stmt->bind_result($id,$order_id,$phone,$amount,$status);		while ($stmt->fetch()) {       			$result['id']=$id;                        $result['order_id']=$order_id;                        $result['phone']=$phone;                        $result['amount']=$amount;                        $result['status']=$status;       			    }		$stmt->close();                return $result;    }        function total_transactions(){        $sql="SELECT COUNT(id) FROM $this->tbl_transctn";		$stmt=$this->mysqli->prepare($sql);		$stmt->execute();                if($stmt->error){                    echo $stmt->error;                }                $stmt->bind_result($count);		while($stmt->fetch()){			$row=$count;                       }                return $row;    } function total_transactions_status($status){        $sql="SELECT COUNT(id) FROM $this->tbl_transctn WHERE status=?";		$stmt=$this->mysqli->prepare($sql);		$stmt->bind_param('s',$status);		$stmt->execute();                if($stmt->error){                    echo $stmt->error;                }                $stmt->bind_result($count);		while($stmt->fetch()){			$row=$count;                       }                return $row;    } function transactions_completed($ord_id){        $sql="SELECT stripid FROM $this->tbl_transctn WHERE status='completed' AND ord_id=?";		$stmt=$this->mysqli->prepare($sql);		$stmt->bind_param('s',$ord_id);		$stmt->execute();                if($stmt->error){                    echo $stmt->error;                }                $stmt->bind_result($stripid);        $row = false;		while($stmt->fetch()){			$row=$stripid;                       }                return $row;    } function transactions_refunded($ord_id){        $sql="SELECT ord_id FROM $this->tbl_transctn WHERE status='refunded' AND ord_id=?";		$stmt=$this->mysqli->prepare($sql);		$stmt->bind_param('s',$ord_id);		$stmt->execute();             if($stmt->error){                    echo $stmt->error;                }        $stmt->bind_result($stripid);		while($stmt->fetch()){			$row=$stripid;                       }                return $row;    } 	function get_transaction($ord_id){		$sql="SELECT timestamp,status,stripid,notes FROM transactions WHERE ord_id=?";		$stmt=$this->mysqli->prepare($sql);		$stmt->bind_param('i',$ord_id);		$stmt->execute();                if($stmt->error){                    echo $stmt->error;                }		$stmt->bind_result($timestamp,$status,$stripid,$notes);		$n=0;        while($stmt->fetch()){			$result[$n]['timestamp']=$timestamp;            $result[$n]['stripid']=$stripid;            $result[$n]['notes']=$notes;            $result[$n]['status']=$status;            $n++;			}		echo $stmt->error;		$stmt->close();		return $result;			}        //SELECT t1.timestamp,t1.status,t1.stripid,t1.notes,t2.phone FROM transactions t1,orders t2 WHERE t1.ord_id=t2.id      function list_transactions($start,$limit,$orderby,$orderval,$keyword){        $columns=array('t1.id','t1.timestamp','t2.phone','t1.status','t1.timestamp','t1.status');                $order=$columns[$orderby];                                $result=array();				if($orderval=="asc"){					$orderval="desc";				}else{					$orderval="asc";				}				                if($keyword){                   $search='%'.$keyword.'%';                   $qu="SELECT t1.timestamp,t1.status,t1.stripid,t1.notes,t2.phone FROM transactions t1,orders t2 WHERE t1.ord_id=t2.id AND t2.phone LIKE ? ORDER BY t1.id LIMIT ? , ?";                   // $qu="SELECT id,order_id,phone,amount,status FROM $this->tbl_orders WHERE phone LIKE ? OR order_id LIKE ? ORDER BY id LIMIT ? , ? ";                   $stmt=$this->mysqli->prepare($qu);                   $stmt->bind_param('sii',$search,$start,$limit);                }  elseif(!$keyword) {                  $qu="SELECT t1.timestamp,t1.status,t1.stripid,t1.notes,t2.phone FROM transactions t1,orders t2 WHERE t1.ord_id=t2.id ORDER BY $order $orderval LIMIT ? , ? ";                   // $qu="SELECT id,order_id,phone,amount,status FROM $this->tbl_orders ORDER BY $order $orderval LIMIT ? , ? ";                    $stmt=$this->mysqli->prepare($qu);                    $stmt->bind_param('ii',$start,$limit);                }                $stmt->execute();                echo $stmt->error;		$stmt->bind_result($timestamp,$status,$stripid,$notes,$phone);		$n=0;                while($stmt->fetch()){			$result[$n]['timestamp']=$timestamp;                        $result[$n]['stripid']=$stripid;                        $result[$n]['phone']=$phone;                        $result[$n]['notes']=$notes;                        $result[$n]['status']=$status;                        $n++;			}				echo $stmt->error;		$stmt->close();		return $result;    }            function delete_transactions($id){        $sql="DELETE FROM $this->tbl_transctn WHERE ord_id=?";		$stmt=$this->mysqli->prepare($sql);                $stmt->bind_param('i', $id);		$stmt->execute();                if($stmt->error){                    echo $stmt->error;                }                return true;    }			                    }